import gzip
import json
from typing import Optional, Literal

import numpy as np
from numpy.typing import NDArray

from ..validation import correct_event_order, correct_local_timestamp, validate_event_order
from ...types import (
    DEPTH_EVENT,
    DEPTH_CLEAR_EVENT,
    DEPTH_SNAPSHOT_EVENT,
    TRADE_EVENT,
    BUY_EVENT,
    SELL_EVENT,
    event_dtype
)


def convert(
        input_filename: str,
        output_filename: Optional[str] = None,
        opt: Literal['', 'm', 't', 'mt'] = '',
        base_latency: float = 0,
        combined_stream: bool = True,
        buffer_size: int = 100_000_000
) -> NDArray:
    r"""
    Converts raw Binance Futures feed stream file into a format compatible with HftBacktest.

    **File Format:**

    .. code-block::

        local_timestamp raw_stream
        1660228023037049 {"stream":"btcusdt@depth@0ms","data":{"e":"depthUpdate","E":1660228023941,"T":1660228023931,"s":"BTCUSDT","U":1801732831593,"u":1801732832589,"pu":1801732831561,"b":[["2467.10","0.000"],["12006.00","0.001"],["24427.70","4.350"],["24620.30","0.172"],["24644.00","44.832"],["24645.40","0.203"],["24652.80","4.900"],["24664.10","4.279"],["24666.50","0.554"],["24666.80","6.764"],["24668.70","7.428"],["24670.90","2.000"],["24671.00","0.000"],["24672.70","0.000"],["24688.30","0.000"]],"a":[["24653.60","0.000"],["24669.80","0.000"],["24670.20","0.000"],["24670.70","0.000"],["24670.90","0.000"],["24671.00","20.812"],["24672.10","0.000"],["24672.30","0.001"],["24674.60","1.520"],["24674.80","0.000"],["24684.20","4.519"],["24684.30","0.202"],["24685.00","0.937"],["24690.90","4.827"],["24693.60","1.500"],["24729.10","0.171"]]}}
        1660228023038319 {"stream":"btcusdt@depth@0ms","data":{"e":"depthUpdate","E":1660228023977,"T":1660228023966,"s":"BTCUSDT","U":1801732832805,"u":1801732834115,"pu":1801732832589,"b":[["2467.10","0.008"],["24643.00","4.457"],["24656.30","0.010"],["24657.70","0.005"],["24658.80","1.000"],["24658.90","1.500"],["24659.50","3.781"],["24659.70","1.806"],["24659.90","0.105"],["24660.60","0.787"],["24666.30","5.033"],["24666.40","0.012"],["24666.50","0.556"],["24668.70","7.426"],["24668.90","0.000"],["24670.90","2.535"],["24680.00","0.000"],["24688.30","0.000"]],"a":[["24653.60","0.000"],["24670.10","0.000"],["24670.60","0.000"],["24670.70","0.000"],["24670.90","0.000"],["24671.00","20.642"],["24672.00","0.000"],["24672.10","0.000"],["24673.50","0.145"],["24673.60","1.567"],["24674.50","3.746"],["24674.60","1.520"],["24678.30","1.304"],["24678.40","0.001"],["24678.80","0.546"],["24678.90","0.002"],["24681.60","0.020"],["24681.70","0.613"],["24681.90","0.077"],["24682.10","3.000"],["24682.20","0.000"],["24683.70","0.163"],["24683.80","4.162"],["24684.00","1.227"],["24684.20","4.519"],["24684.30","0.202"],["24684.90","1.331"],["24685.70","0.156"],["24685.80","0.325"],["24686.70","0.648"],["24692.60","0.040"],["24700.00","47.420"],["24729.10","0.006"]]}}
        1660228023043260 {"stream":"btcusdt@trade","data":{"e":"trade","E":1660228023980,"T":1660228023973,"s":"BTCUSDT","t":2691833663,"p":"24670.90","q":"0.022","X":"MARKET","m":true}}
        1660228023052991 {"stream":"btcusdt@trade","data":{"e":"trade","E":1660228023991,"T":1660228023983,"s":"BTCUSDT","t":2691833664,"p":"24671.00","q":"0.001","X":"MARKET","m":false}}
        1660228023071108 {"stream":"btcusdt@depth@0ms","data":{"e":"depthUpdate","E":1660228024010,"T":1660228024002,"s":"BTCUSDT","U":1801732834136,"u":1801732835323,"pu":1801732834115,"b":[["2467.10","0.000"],["12006.00","0.000"],["24599.40","0.641"],["24603.20","0.104"],["24625.50","0.152"],["24645.20","0.476"],["24646.80","0.081"],["24652.60","0.254"],["24664.10","4.279"],["24666.50","0.878"],["24668.80","0.004"],["24670.90","2.513"],["24688.30","0.000"],["24787.00","0.000"]],"a":[["24653.60","0.000"],["24668.10","0.000"],["24668.70","0.000"],["24669.50","0.000"],["24669.80","0.000"],["24670.00","0.000"],["24670.60","0.000"],["24670.70","0.000"],["24670.90","0.000"],["24671.00","20.641"],["24672.20","0.000"],["24672.30","0.001"],["24673.50","0.040"],["24673.90","0.105"],["24674.70","2.139"],["24674.80","0.000"],["24683.70","0.963"],["24683.90","0.009"],["24685.70","0.556"],["24709.30","0.254"],["24723.80","0.000"],["24728.30","0.193"],["24729.50","4.477"],["24739.40","0.807"],["24743.20","0.235"],["24795.00","0.130"]]}}
        1660228023117894 {"stream":"btcusdt@depth@0ms","data":{"e":"depthUpdate","E":1660228024044,"T":1660228024034,"s":"BTCUSDT","U":1801732835406,"u":1801732836571,"pu":1801732835323,"b":[["2467.10","0.000"],["24337.10","2.462"],["24616.50","1.050"],["24619.00","0.235"],["24640.00","5.148"],["24649.80","2.805"],["24650.00","14.374"],["24651.90","3.000"],["24653.30","1.400"],["24658.70","1.142"],["24658.80","0.000"],["24659.60","3.263"],["24659.70","0.006"],["24660.50","0.840"],["24660.60","0.387"],["24662.20","0.202"],["24663.10","7.147"],["24664.00","0.922"],["24664.20","0.131"],["24664.50","0.027"],["24666.20","7.066"],["24666.40","0.012"],["24668.80","0.002"],["24669.30","0.002"],["24670.20","0.811"],["24670.90","5.817"],["24688.30","0.000"]],"a":[["24653.60","0.000"],["24669.80","0.000"],["24669.90","0.000"],["24670.90","0.000"],["24671.00","20.121"],["24672.10","0.000"],["24672.80","0.000"],["24674.60","1.520"],["24675.30","0.421"],["24681.20","0.239"],["24681.50","1.343"],["24681.60","0.020"],["24681.70","0.213"],["24683.60","2.929"],["24683.70","0.163"],["24683.80","2.162"],["24684.70","0.646"],["24684.90","0.731"],["24692.90","0.321"],["24693.10","0.040"],["24700.70","0.537"],["24703.60","0.210"],["24721.50","7.245"]]}}
        1660228023125009 {"stream":"btcusdt@trade","data":{"e":"trade","E":1660228024062,"T":1660228024055,"s":"BTCUSDT","t":2691833665,"p":"24670.90","q":"0.002","X":"MARKET","m":true}}
        1660228023128966 {"stream":"btcusdt@trade","data":{"e":"trade","E":1660228024067,"T":1660228024061,"s":"BTCUSDT","t":2691833666,"p":"24670.90","q":"0.020","X":"MARKET","m":true}}
        1660228023138740 {"stream":"btcusdt@depth@0ms","data":{"e":"depthUpdate","E":1660228024077,"T":1660228024066,"s":"BTCUSDT","U":1801732836639,"u":1801732837803,"pu":1801732836571,"b":[["2467.10","0.000"],["24659.00","0.000"],["24659.30","2.500"],["24663.00","1.038"],["24664.20","0.118"],["24666.20","7.065"],["24666.50","0.554"],["24666.70","3.987"],["24666.80","7.088"],["24666.90","0.014"],["24667.40","1.506"],["24668.90","0.006"],["24670.10","0.272"],["24670.90","6.726"],["24688.30","0.000"]],"a":[["24653.60","0.000"],["24668.70","0.000"],["24670.30","0.000"],["24670.50","0.000"],["24670.90","0.000"],["24679.00","0.001"],["24703.10","1.500"],["24710.50","0.057"],["24728.30","0.028"],["24768.50","0.318"],["24980.10","5.446"],["25050.00","119.300"]]}}
        1660228023149748 {"stream":"btcusdt@trade","data":{"e":"trade","E":1660228024088,"T":1660228024081,"s":"BTCUSDT","t":2691833667,"p":"24671.00","q":"0.063","X":"MARKET","m":false}}
        ## book
        # snapshot
        b'1727505821255949023 {"c":"book","M":"usdttwd","e":"snapshot","a":[["31.85","43916.05"],["31.851","795"],["31.852","323.79"],["31.856","19.2"],["31.857","308.06"],["31.858","56.57"],["31.86","10143.1"],["31.862","9.82"],["31.864","10.64"],["31.866","15801.25"],["31.868","118.47"],["31.87","15727.62"],["31.873","19.23"],["31.874","10.18"],["31.875","11.85"],["31.878","10"],["31.88","12.5"],["31.881","12.8"],["31.882","9.84"],["31.883","17.93"],["31.885","9.59"],["31.887","9.59"],["31.888","32.68"],["31.89","55419.66"],["31.892","10.9"],["31.893","48000"],["31.894","57.12"],["31.895","55516.68"],["31.897","22.03"],["31.898","29.3"],["31.899","1800"],["31.9","107995.26"],["31.901","9.71"],["31.903","66.32"],["31.905","10.61"],["31.906","13.53"],["31.907","9.87"],["31.908","180.02"],["31.909","72.08"],["31.91","49894.15"],["31.912","9.97"],["31.913","12.23"],["31.914","10.42"],["31.915","10.5"],["31.916","1227.23"],["31.917","9.88"],["31.918","21.74"],["31.92","504.18"],["31.922","9.99"],["31.923","11.27"]],"b":[["31.711","10.51"],["31.713","13.71"],["31.718","19.68"],["31.72","19243.7"],["31.726","43.73"],["31.727","315.19"],["31.728","33.66"],["31.733","630.26"],["31.738","10.03"],["31.74","22.27"],["31.743","20.29"],["31.744","11.29"],["31.748","10.03"],["31.75","749.02"],["31.759","43.69"],["31.76","1523.84"],["31.761","9.6"],["31.764","104.2"],["31.772","94.43"],["31.779","10.51"],["31.78","159.94"],["31.783","10.63"],["31.788","3145.84"],["31.79","137.62"],["31.793","43.69"],["31.795","11.29"],["31.8","2437.07"],["31.801","3147.53"],["31.802","716.97"],["31.803","1641.26"],["31.806","314.41"],["31.807","3458.46"],["31.808","2416.84"],["31.814","392.77"],["31.82","2089.77"],["31.821","8"],["31.822","8"],["31.823","8"],["31.825","1094.21"],["31.826","1490.06"],["31.827","392.77"],["31.828","785.49"],["31.83","16770.86"],["31.831","61605.02"],["31.832","37620.64"],["31.837","12159.02"],["31.839","392.58"],["31.84","392.58"],["31.844","631.01"],["31.849","36646.2"]],"T":1727505817987,"fi":79417,"li":79417,"v":1727429463829}\n'
        b'1727505829846816755 {"c":"book","M":"usdttwd","e":"update","a":[],"b":[["31.837","8389.82"]],"T":1727505829117,"fi":79423,"li":79423,"v":1727429463829}\n'
        # update 
        ## trade
        b'1727505821256651432 {"c":"trade","M":"usdttwd","e":"snapshot","t":[{"p":"31.845","v":"31.41","T":1727505576844,"tr":"up"},{"p":"31.845","v":"9.61","T":1727505582175,"tr":"up"},{"p":"31.845","v":"47.11","T":1727505589128,"tr":"up"},{"p":"31.845","v":"9.42","T":1727505600612,"tr":"up"},{"p":"31.845","v":"9.41","T":1727505600663,"tr":"up"},{"p":"31.845","v":"9.42","T":1727505601119,"tr":"up"},{"p":"31.845","v":"9.41","T":1727505601438,"tr":"up"},{"p":"31.845","v":"20.14","T":1727505601792,"tr":"up"},{"p":"31.845","v":"1570.1","T":1727505602345,"tr":"up"},{"p":"31.845","v":"15854.99","T":1727505602611,"tr":"up"},{"p":"31.845","v":"1715.57","T":1727505602643,"tr":"up"},{"p":"31.845","v":"1570.1","T":1727505603464,"tr":"up"},{"p":"31.845","v":"300.0","T":1727505603591,"tr":"up"},{"p":"31.845","v":"414.33","T":1727505603696,"tr":"up"},{"p":"31.845","v":"801.82","T":1727505603729,"tr":"up"},{"p":"31.845","v":"3082.66","T":1727505603763,"tr":"up"},{"p":"31.845","v":"5869.42","T":1727505605972,"tr":"up"},{"p":"31.845","v":"15.65","T":1727505613202,"tr":"up"},{"p":"31.844","v":"464.65","T":1727505620041,"tr":"down"},{"p":"31.845","v":"31.42","T":1727505626515,"tr":"up"},{"p":"31.845","v":"13.0","T":1727505631732,"tr":"up"},{"p":"31.845","v":"8.01","T":1727505632431,"tr":"up"},{"p":"31.845","v":"11.84","T":1727505632697,"tr":"up"},{"p":"31.845","v":"13.0","T":1727505632761,"tr":"up"},{"p":"31.845","v":"157.01","T":1727505647560,"tr":"up"},{"p":"31.845","v":"9840.0","T":1727505672339,"tr":"up"},{"p":"31.845","v":"1570.1","T":1727505677143,"tr":"up"},{"p":"31.845","v":"20.05","T":1727505677493,"tr":"up"},{"p":"31.845","v":"1570.1","T":1727505677936,"tr":"up"},{"p":"31.845","v":"4298.81","T":1727505678354,"tr":"up"},{"p":"31.845","v":"500.0","T":1727505679096,"tr":"up"},{"p":"31.845","v":"2186.41","T":1727505679520,"tr":"up"},{"p":"31.845","v":"1255.44","T":1727505679553,"tr":"up"},{"p":"31.845","v":"942.06","T":1727505679588,"tr":"up"},{"p":"31.845","v":"1252.66","T":1727505679627,"tr":"up"},{"p":"31.845","v":"232.85","T":1727505679664,"tr":"up"},{"p":"31.845","v":"1019.81","T":1727505679714,"tr":"up"},{"p":"31.845","v":"550.29","T":1727505679746,"tr":"up"},{"p":"31.845","v":"20.05","T":1727505680081,"tr":"up"},{"p":"31.845","v":"591.56","T":1727505680533,"tr":"up"},{"p":"31.845","v":"10.4","T":1727505680566,"tr":"up"},{"p":"31.845","v":"464.63","T":1727505680600,"tr":"up"},{"p":"31.845","v":"0.02","T":1727505680649,"tr":"up"},{"p":"31.846","v":"11.28","T":1727505680992,"tr":"up"},{"p":"31.847","v":"10.5","T":1727505681031,"tr":"up"},{"p":"31.848","v":"10.0","T":1727505681069,"tr":"up"},{"p":"31.848","v":"9.59","T":1727505681110,"tr":"up"},{"p":"31.848","v":"19.23","T":1727505681146,"tr":"up"},{"p":"31.849","v":"0.02","T":1727505681181,"tr":"up"},{"p":"31.849","v":"19.23","T":1727505681516,"tr":"up"},{"p":"31.849","v":"986.81","T":1727505682615,"tr":"up"},{"p":"31.849","v":"5868.68","T":1727505682821,"tr":"up"},{"p":"31.849","v":"986.69","T":1727505683908,"tr":"up"},{"p":"31.849","v":"5492.1","T":1727505684508,"tr":"up"},{"p":"31.849","v":"376.58","T":1727505684543,"tr":"up"},{"p":"31.849","v":"1569.91","T":1727505684628,"tr":"up"},{"p":"31.849","v":"31.34","T":1727505685008,"tr":"up"},{"p":"31.849","v":"1003.29","T":1727505685200,"tr":"up"},{"p":"31.849","v":"20.05","T":1727505685303,"tr":"up"},{"p":"31.849","v":"20.05","T":1727505685359,"tr":"up"},{"p":"31.849","v":"1000.0","T":1727505685708,"tr":"up"},{"p":"31.849","v":"1569.91","T":1727505685755,"tr":"up"},{"p":"31.849","v":"313.98","T":1727505685830,"tr":"up"},{"p":"31.849","v":"491.43","T":1727505686265,"tr":"up"},{"p":"31.849","v":"2587.32","T":1727505686311,"tr":"up"},{"p":"31.849","v":"31.39","T":1727505686712,"tr":"up"},{"p":"31.849","v":"505.36","T":1727505686860,"tr":"up"},{"p":"31.849","v":"31.41","T":1727505687400,"tr":"up"},{"p":"31.849","v":"239.64","T":1727505687830,"tr":"up"},{"p":"31.849","v":"500.04","T":1727505688004,"tr":"up"},{"p":"31.849","v":"1000.0","T":1727505688053,"tr":"up"},{"p":"31.849","v":"176.83","T":1727505688276,"tr":"up"},{"p":"31.849","v":"13.01","T":1727505689522,"tr":"up"},{"p":"31.849","v":"109.89","T":1727505698649,"tr":"up"},{"p":"31.848","v":"25.38","T":1727505702251,"tr":"down"},{"p":"31.849","v":"15.69","T":1727505707511,"tr":"up"},{"p":"31.849","v":"11.08","T":1727505711920,"tr":"up"},{"p":"31.849","v":"2000.0","T":1727505721513,"tr":"up"},{"p":"31.848","v":"82.98","T":1727505726159,"tr":"down"},{"p":"31.849","v":"1569.92","T":1727505729891,"tr":"up"},{"p":"31.849","v":"313.98","T":1727505734542,"tr":"up"},{"p":"31.849","v":"159.96","T":1727505735949,"tr":"up"},{"p":"31.849","v":"68.84","T":1727505737220,"tr":"up"},{"p":"31.849","v":"25.38","T":1727505737252,"tr":"up"},{"p":"31.849","v":"82.98","T":1727505737284,"tr":"up"},{"p":"31.85","v":"43.91","T":1727505739459,"tr":"up"},{"p":"31.85","v":"500.0","T":1727505746757,"tr":"up"},{"p":"31.85","v":"6000.0","T":1727505750548,"tr":"up"},{"p":"31.85","v":"314.57","T":1727505753327,"tr":"up"},{"p":"31.85","v":"34.54","T":1727505753684,"tr":"up"},{"p":"31.85","v":"67.99","T":1727505768963,"tr":"up"},{"p":"31.85","v":"470.97","T":1727505780176,"tr":"up"},{"p":"31.85","v":"11.95","T":1727505783820,"tr":"up"},{"p":"31.85","v":"11.82","T":1727505785189,"tr":"up"},{"p":"31.849","v":"8.0","T":1727505786995,"tr":"down"},{"p":"31.85","v":"784.0","T":1727505793482,"tr":"up"},{"p":"31.85","v":"41.13","T":1727505805500,"tr":"up"},{"p":"31.85","v":"125.59","T":1727505813328,"tr":"up"},{"p":"31.85","v":"47.1","T":1727505813467,"tr":"up"},{"p":"31.85","v":"10.54","T":1727505817959,"tr":"up"}],"T":1727505817979}\n'
        b'1727505821424819167 {"c":"trade","M":"usdttwd","e":"update","t":[{"p":"31.85","v":"91.06","T":1727505820692,"tr":"up"}],"T":1727505820718}\n'

    Args:
        input_filename: Input filename with path.
        output_filename: If provided, the converted data will be saved to the specified filename in ``npz`` format.
        opt: Additional processing options:

             - ``m``: Processes ``markPriceUpdate`` stream with the following custom event IDs.

                - index: ``100``
                - mark price: ``101``
                - funding rate: ``102``

             - ``t``: Processes ``bookTicker`` stream with the following custom event IDs.

                - best bid: ``103``
                - best ask: ``104``

        base_latency: The value to be added to the feed latency.
                      See :func:`.correct_local_timestamp`.
        combined_stream: Raw stream type.
                         **combined stream:**

                         .. code-block::

                             {"stream":"solusdt@bookTicker","data":{"e":"bookTicker","u":4456408609867,"s":"SOLUSDT","b":"142.4440","B":"50","a":"142.4450","A":"3","T":1713571200009,"E":1713571200010}}
                             regular stream:
                             {"e":"bookTicker","u":4456408609867,"s":"SOLUSDT","b":"142.4440","B":"50","a":"142.4450","A":"3","T":1713571200009,"E":1713571200010}


    Returns:
        Converted data compatible with HftBacktest.
    """
    timestamp_slice = 19
    timestamp_mul = 1000000

    tmp = np.empty(buffer_size, event_dtype)
    row_num = 0
    with gzip.open(input_filename, 'r') as f:
        while True:
            line = f.readline()
            if not line:
                break
            local_timestamp = int(line[:timestamp_slice])
            message = json.loads(line[timestamp_slice + 1:])

            ##
            data = message
            evt = data['c']
            type = data['e']

            if type == 'snapshot':
                if evt == 'book':
                    # snapshot
                    # event_time = msg['E']
                    transaction_time = message['T']
                    bids = message['b']
                    asks = message['a']
                    exch_timestamp = int(transaction_time) * timestamp_mul
                    if len(bids) > 0:
                        bid_clear_upto = float(bids[-1][0])
                        # clears the existing market depth upto the prices in the snapshot.
                        tmp[row_num] = (
                            DEPTH_CLEAR_EVENT | BUY_EVENT,
                            exch_timestamp,
                            local_timestamp,
                            bid_clear_upto,
                            0,
                            0,
                            0,
                            0
                        )
                        row_num += 1
                        # inserts the snapshot.
                        for px, qty in bids:
                            tmp[row_num] = (
                                DEPTH_SNAPSHOT_EVENT | BUY_EVENT,
                                exch_timestamp,
                                local_timestamp,
                                float(px),
                                float(qty),
                                0,
                                0,
                                0
                            )
                            row_num += 1
                    if len(asks) > 0:
                        ask_clear_upto = float(asks[-1][0])
                        # clears the existing market depth upto the prices in the snapshot.
                        tmp[row_num] = (
                            DEPTH_CLEAR_EVENT | SELL_EVENT,
                            exch_timestamp,
                            local_timestamp,
                            ask_clear_upto,
                            0,
                            0,
                            0,
                            0
                        )
                        row_num += 1
                        # inserts the snapshot.
                        for px, qty in asks:
                            tmp[row_num] = (
                                DEPTH_SNAPSHOT_EVENT | SELL_EVENT,
                                exch_timestamp,
                                local_timestamp,
                                float(px),
                                float(qty),
                                0,
                                0,
                                0
                            )
                            row_num += 1
            elif type == 'update':
                if evt == 'trade':
                    trades = data['t']
                    for trade in trades:
                        transaction_time = data['T'] #13
                        price = data['p']
                        qty = data['v']
                        exch_timestamp = int(transaction_time) * timestamp_mul
                        tmp[row_num] = (
                            TRADE_EVENT | (SELL_EVENT if data['m'] else BUY_EVENT), # trade initiator's side
                            exch_timestamp,
                            local_timestamp,
                            float(price),
                            float(qty),
                            0,
                            0,
                            0
                        )
                        row_num += 1
                elif evt == 'book':
                    # event_time = data['E']
                    transaction_time = data['T']
                    exch_timestamp = int(transaction_time) * timestamp_mul
                    for px, qty in data['b']:
                        tmp[row_num] = (
                            DEPTH_EVENT | BUY_EVENT,
                            exch_timestamp,
                            local_timestamp,
                            float(px),
                            float(qty),
                            0,
                            0,
                            0
                        )
                        row_num += 1
                    for px, qty in data['a']:
                        tmp[row_num] = (
                            DEPTH_EVENT | SELL_EVENT,
                            exch_timestamp,
                            local_timestamp,
                            float(px),
                            float(qty),
                            0,
                            0,
                            0
                        )
                        row_num += 1

            # ##
            # if combined_stream:
            #     data = message.get('data')
            # else:
            #     data = message


    tmp = tmp[:row_num]

    print('Correcting the latency')
    tmp = correct_local_timestamp(tmp, base_latency)

    print('Correcting the event order')
    data = correct_event_order(
        tmp,
        np.argsort(tmp['exch_ts'], kind='mergesort'),
        np.argsort(tmp['local_ts'], kind='mergesort')
    )

    validate_event_order(data)

    if output_filename is not None:
        print('Saving to %s' % output_filename)
        np.savez_compressed(output_filename, data=data)

    return data
